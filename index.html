<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WhiteMuse</title>

  <!-- PWA -->
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-title" content="WhiteMuse">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon.svg">

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --ink:#111; --muted:#666;
      --line:#e6e8ee; --btn:#111; --btn2:#fff; --accent:#111;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Sans",sans-serif;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(246,247,249,.9); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px 14px 10px;
    }
    h1{margin:0; font-size:20px; letter-spacing:.2px}
    .sub{margin-top:6px; color:var(--muted); font-size:12px}
    main{padding:14px; max-width:1100px; margin:0 auto}
    .grid{display:grid; gap:12px}
    @media(min-width:980px){ .grid{grid-template-columns: 1fr 1fr;} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
      box-shadow:0 4px 14px rgba(0,0,0,.05);
    }
    .card h2{margin:0 0 10px; font-size:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none; border:1px solid #111; background:#111; color:#fff;
      padding:12px 14px; border-radius:12px; font-size:14px; font-weight:700;
      width:100%;
    }
    .btn.secondary{background:#fff; color:#111; border-color:#cfd3dd}
    .btn.small{padding:10px 12px; width:auto}
    .btn:disabled{opacity:.45}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background:#fff; color:#111; font-size:13px;
    }
    .help{color:var(--muted); font-size:12px; line-height:1.45}
    input[type="range"]{width:100%}
    select, input[type="text"]{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--line); font-size:14px; background:#fff;
    }
    textarea{
      width:100%; min-height:200px; resize:vertical;
      padding:12px; border-radius:12px; border:1px solid var(--line);
      font-size:14px; line-height:1.6; background:#fff;
    }

    .thumbs{
      display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;
    }
    @media(min-width:700px){ .thumbs{grid-template-columns: repeat(3, 1fr);} }
    .shot{
      border:1px solid var(--line);
      border-radius:12px; background:#fff; padding:10px;
    }
    .shot .cap{font-size:12px; color:var(--muted); margin-top:6px}
    .canvasWrap{
      width:100%; aspect-ratio: 1 / 1;
      border-radius:10px; overflow:hidden; background:#fff;
      border:1px solid var(--line);
      display:flex; align-items:center; justify-content:center;
    }
    canvas{max-width:100%; max-height:100%}
    .split{
      display:grid; gap:10px;
      grid-template-columns: 1fr;
    }
    @media(min-width:980px){ .split{grid-template-columns: 1fr 1fr;} }

    .kv{display:grid; grid-template-columns: 120px 1fr; gap:8px; font-size:13px}
    .kv div:nth-child(odd){color:var(--muted)}
    .warn{
      border:1px solid #f1d18b;
      background:#fff7e6;
      padding:10px; border-radius:12px; color:#6b4a00; font-size:13px;
    }
    .ok{
      border:1px solid #bfe6c6;
      background:#f0fff2;
      padding:10px; border-radius:12px; color:#105b1d; font-size:13px;
    }
    .hr{height:1px; background:var(--line); margin:10px 0}
    .tiny{font-size:12px; color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .hidden{display:none !important;}
  </style>
</head>

<body>
<header>
  <h1>WhiteMuse</h1>
  <div class="sub">撮る → 自動で整える → 読み取る → 売れる文章まで（端末内中心 / プライバシー重視）</div>
</header>

<main class="grid">

  <section class="card">
    <h2>① 写真を選ぶ（最大10枚）</h2>

    <div class="row">
      <input id="fileInput" type="file" accept="image/*" multiple style="width:100%; padding:10px;">
    </div>

    <div class="help" style="margin-top:8px">
      iPhoneは「写真を撮る / 選ぶ」が出ます。<br>
      <b>コツ：</b>商品は中央、背景はなるべく単色、影は自然に。
    </div>

    <div class="hr"></div>

    <h2>② 自動でプロ写真に整える</h2>

    <div class="row">
      <span class="pill">強さ（0=弱い / 100=しっかり）</span>
      <div style="flex:1; min-width:240px">
        <input id="strength" type="range" min="0" max="100" value="70">
        <div class="tiny">今：<span id="strengthVal">70</span></div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn small secondary" id="presetEdge">輪郭優先</button>
      <button class="btn small secondary" id="presetSoftShadow">影弱め</button>
      <button class="btn small secondary" id="presetWhiteStrong">白強め</button>
    </div>

    <div class="row" style="margin-top:10px">
      <select id="category">
        <option value="auto">カテゴリ（自動）</option>
        <option value="bag">バッグ</option>
        <option value="wallet">財布</option>
        <option value="watch">時計</option>
        <option value="accessory">アクセサリー</option>
      </select>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="runFix" disabled>ワンタップ補正（最大10枚）</button>
    </div>

    <div class="help" style="margin-top:8px">
      できること：背景を白（#FFFFFF）／自然な影／明るさ・色・くっきりを自動調整／写真の情報（位置情報など）を削除。<br>
      ※ 背景がごちゃごちゃだと、白抜き精度が落ちます（後で改善ロードマップあり）。
    </div>

    <div class="hr"></div>

    <h2>③ 写真から自動推定（文字の読み取り）</h2>
    <div class="row">
      <button class="btn secondary" id="runOcr" disabled>ロゴ/刻印/タグ を読み取る（端末内）</button>
    </div>

    <div class="help" style="margin-top:8px">
      読めない時は「撮り直しガイド」を出します。確度（自信度）も表示します。
    </div>

    <div class="hr"></div>

    <h2>④ 売れる出品文を作る</h2>

    <div class="row">
      <select id="mode">
        <option value="aggressive">攻め（即売れ狙い）</option>
        <option value="elegant">上品（富裕層・価格維持）</option>
        <option value="auto">おまかせ（AI判断）</option>
      </select>
    </div>

    <div class="row" style="margin-top:10px">
      <input id="titleHint" type="text" placeholder="（任意）短いメモ：例）黒 ラムスキン チェーン ショルダー / エルメス トート">
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="genText" disabled>出品文を生成</button>
    </div>

    <div class="row" style="margin-top:10px">
      <textarea id="outputText" placeholder="ここに出品文が出ます（毎回、言い回し・構成が変わります）"></textarea>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn secondary" id="copyText" disabled>コピー</button>
    </div>

    <div class="hr"></div>

    <h2>⑤ 学習（任意）</h2>
    <div class="row">
      <button class="btn secondary" id="btnListed" disabled>この文章で出品した</button>
      <button class="btn secondary" id="btnSold" disabled>売れた</button>
      <button class="btn secondary" id="btnResetLearn">学習を消す（端末内）</button>
    </div>
    <div class="help" style="margin-top:8px">
      大きな学習はしません。あなたの「勝ちパターン（文の癖）」だけを端末内に軽量保存します。
    </div>

    <div class="hr"></div>

    <h2>⑥ 書き出し（Web用 / メルカリ用）</h2>
    <div class="row">
      <button class="btn secondary" id="exportWeb" disabled>Web用：JPEG高品質 + PNG（まとめて）</button>
      <button class="btn secondary" id="exportMercari" disabled>メルカリ用：JPEG高品質 + PNG（まとめて）</button>
    </div>
    <div class="help" style="margin-top:8px">
      自動ファイル名：<span class="mono">WhiteMuse_カテゴリ_日付_連番</span><br>
      画像は「描き直し保存」なので、写真の中の余計な情報（位置情報など）は基本的に残りません。
    </div>
  </section>

  <section class="card">
    <h2>プレビュー（Before / After）</h2>

    <div id="statusBox" class="warn">
      まだ写真がありません。まず①で写真を選んでください。
    </div>

    <div class="hr"></div>

    <div class="thumbs" id="thumbs"></div>

    <div class="hr"></div>

    <h2>推定結果（読み取り）</h2>
    <div id="ocrBox" class="tiny">まだ読み取りしていません。</div>

    <div class="hr"></div>

    <h2>タイトル案（メルカリショップ向け）</h2>
    <div id="titleBox" class="tiny">まだありません。</div>

    <div class="hr"></div>

    <h2>在庫ロック（売り違い防止）</h2>
    <div class="ok">
      MVPでは「他サイトへ自動取り消し」は規約・仕様の都合で無理があるため、<b>半自動</b>で安全にやります。<br>
      1商品ごとに「ロックON」を持ち、売れたら通知して「取り消しチェック」を出します（端末内）。
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn secondary" id="lockToggle" disabled>在庫ロック：OFF</button>
      <button class="btn secondary" id="soldNow" disabled>この商品が売れた（通知）</button>
    </div>

    <div class="hr"></div>

    <h2>撮り直しガイド（読めない時）</h2>
    <div id="retakeGuide" class="tiny">
      まだありません。
    </div>
  </section>

</main>

<!-- 端末内OCR（CDN読み込み。処理は端末内） -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<!-- まとめ保存（ZIP） -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script type="module" src="./main.js"></script>

<script>
  // Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }
</script>
</body>
</html>
